<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>れもんが大学図書館で30日OS本見つけた話</title>
<link rel="stylesheet" href="index.css">
<link rel="stylesheet" href="menu.css">
<script src="footnote.js"></script>
</head>
<body>
<p>れもん(<a href="https://twitter.com/_lem0n_">Twitter</a>)が30日OS本やっていく。
<h1>リアル1日目</h1>
<p>date:2018/07/13 16:30-17:30</p>
<p>煩大の<s>つまらない</s>素晴らしい4限の講義も終わり、私の所属しているOUCC<sup><a class="ref" title="パソコンについて色々活動してるクラブ。"></a></sup>の部会まで暇なので、図書館に行ってみた。豊中キャンパスの総合図書館は、情報系の本がそこそこ揃っているので、我々<ruby>JK<rt>情報科学科</rt></ruby>1回生にとっては非常に重要な存在である<sup>[要出典]</sup>。</p>
<p>……おや？これはいわゆる<b>30日OS本</b>では？</p>
<figure><img src="pictures/1-1.JPG"><figcaption>いかにも重厚そう(それはそうである)</figcaption></figure>
<p>ひたすらヤバい本(!!)であるとTwitterでしばしば話題になっているが、詳細はあまりよく知らない。でも読んでみたいこの一冊。まさかこれが入ってるとは、やっぱ図書館<b>は</b>有能だな。図書館<b>は</b>。大学上層部に爪の垢を煎じて 噴 霧 機 で 散 布 <sup><a class="ref" title="オウムかな？"></a></sup>してやりたいものだ。とりあえず1時間ぐらい空いてるし始めてみようと思う。</p>
<h2>0日目</h2>
<p>これは序章らしきものである。前書きは作者の伝えたいことが書いてあるって、かのシェイクスピアも言ってたから。うんうん。知らんけど</p>
<p>読んだ感想。知識0からできるそうだが(本当に？)、とりあえずOS作りに必要な知識を拾っていきたい所存。最終的には悠里OS<sup><a class="ref" title="創作界隈悠里で開発している架空のOS。詳しくはggってね"></a></sup>の方にまともな貢献をするための基礎知識が欲しい！(それよりも5000兆円欲しい！)</p>
<h2>1日目</h2>
<p>早速組んでいくわけだが、CDを犯大生協のLet's noteに入れようとしたらブオンブオンうるさい。仕方がなく代替ファイルが無いかggったら、<a href="http://hrb.osask.jp/">こんな公式サイト</a>があったのね。必要最低限のファイルを取ってきた。
<p>まずバイナリ組むらしい。わーいBZエディタたのしーい！</p>
<figure><img src="pictures/1-1.png"><figcaption>因みに0打ちはコピペが楽。</figcaption></figure>
<p>できた！</p>
<figure><img src="pictures/1-2.png"><figcaption>imgファイル。</figcaption></figure>
<p>うごいた！</p>
<figure><img src="pictures/1-3.png"><figcaption>QEMU、聞いたことしかなかった</figcaption></figure>
<p>ここで、作者オリジナルのアセンブリを組むらしい。下図L.27~L.30の文字列のところはある程度自由にできるそうなのでいぢる。これが初オリジナル要素なんだなぁ。</p>
<figure><img src="pictures/1-4.png"><figcaption>そこのお前！れもん一個に含まれるビタミンCはレモン3個分だぜ</figcaption></figure>
<figure><img src="pictures/1-5.png"><figcaption>そこのお前！(ry</figcaption></figure>
<h2>今日の感想</h2>
<p>やはり1日目まで読んでなおこの本の良心がまだ残っているので、何よりである。</p>
<h1>リアル2日目</h1>
<p>date:2018/07/14 1:00-1:30</p>
<h2>2日目</h2>
<p>これを読んでいくうえでどうしても付属のCD-ROMに入っているデータが欲しかったので、夜中にLet's noteの五月蝿いドライブをぶんぶん回して全部コピペしてきた。私が低周波公害である。</p>
<p>date:10:00-10:30</p>
<p>読了！アセンブリをもう少しやる感じだけど、普通に理解。しっかし、x86ってレジスタ多いねぇ(2003f<sup><a class="ref" title="先に述べた悠里OSにおいて最初に開発されたマシンの名前。"></a></sup>が少ないだけでこれが普通である)。それと、Makefile便利ねぇ。</p>
<figure><img src="pictures/2-1.png"><figcaption>5000兆円欲しい！</figcaption></figure>
<h2>今日の感想</h2>
<p>まとまった時間が取れなかったが、進めれてる。多分</p>
<h1>リアル3日目</h1>
<p>date:2018/07/15 07:15-08:30</p>
<p>昨日はRPG研<sup><a class="ref" title="大阪大学RPG研究会。主にTRPGをやっている。たまにボドゲ。"></a></sup>でキャンペーンのセッションやってたのです。楽しかった。けど疲れたので昼まで休んで、レポート書いて、今からOS本。
<h2>3日目</h2>
<p>はい、出た、旧時代の利器フロッピー。この本10年以上前のものなので出てくるんですが、今はもはやHDDを超えてSSDなので、正味そこだけ聞き流してブートセクタの説明だけ見解けば大丈夫かな。結構今でもなお続いてる仕様多そうだし。</p>
<figure><img src="pictures/3-1.png"><figcaption>父親の実家に大量にあるけど多分全部死んでる。</figcaption></figure>
<p>…と思ったんだけどさぁ、フロッピーの話大杉。シリンダとかはHDDまでなら十分使える話だけど、ねぇ。<s>メモリ256Gの時代やで</s>まぁいいか。続けよう。</p>
<p>date:23:00-24:00</p>
<p>ついついDoki Doki Literature Club<sup><a class="ref" title="有名なビジュアルノベルゲー。女の子たちがかわいいし、おすすめのゲームだよ！(闇)"></a></sup>の実況みてて気がそれてしまった…ヤバいよねあれ。</p>
<p>さて、OSの方はと言うと、ブートは終わってOS本体。やったぜ。さてさて、本体は「なんとか.sys」らしい。こいつを読み込んで実行するのがIPLの役目なのであったわけだな。本体に色々書いていくわけだけども、まずは試しに黒い画面を表示しようということらしい。ほむ。</p>
<figure><img src="pictures/3-2.png"><figcaption>べっ…別に、ペイントで黒く塗ったわけじゃないんだからね///(当然である)</figcaption></figure>
<p>わーい！動いた動いた！よし、OS完成！(違うんだよなぁ…)さて、これからは<ruby><b>超高級アセンブリ言語</b><rt>C言語</rt></ruby>を用いて開発するらしい。いよいよ本番だね。</p>
<p>――――読み込み中――――</p>
<p>…っあﾞ～～！！<b>goto</b><sup><a class="ref" title="かの有名な計算機科学者Dijkstraが嫌ったという諸悪の根源。こいつでできたスパゲッティは美味いか？なぁ？"></a></sup>！！やっぱりCは<b>超高級アセンブリ言語</b>だぜ！！<b>超高級アセンブリ言語</b>のすることは違うなぁ！！…はい、まじめにやります。Cのコンパイルには何段階かあるようで、アセンブリにして―、いぢくってー、機械語にして―。それを筆者は全てMakefileにしてくれてるわけである。うーん、有能。今日はこれで終わりかな。</p>
<h2>4日目</h2>
<p>ほむ。Cからメモリに書き込みたい？ほならね、ポインタ使えって話でしょ？<sup><a class="ref" title="某土竜youtuberのほならね理論という有名なセリフから。"></a></sup>げっ、作者はこんなひねくれ読者にも対応していらっしゃる。</p>
<blockquote><p>＞ <b>メモリに書き込む命令がない：</b>うそだ、あるじゃないか！　と思ったあなたは、この本の対象読者としては、かなり物知りである。</p></blockquote>
<p>見事に著者から はいプロ 世界一C言語が上手 プログラム界のtourist アセンブリ時代の終焉を告げるもの 実質コンパイラ C言語完全に理解するために生まれてきた男<sup><a class="ref" title="はいプロ構文。競プロ界隈発祥。人を煽るのに使われる。"></a></sup>と煽られたので次行こう。</p>
<p>VRAMに数値を書き込んでいくようで、非常に楽しそうなことしていらっしゃる。どれ、一つ何か書いてみよう。</p>
<figure><img src="pictures/4-1.png"><figcaption>目に悪い。</figcaption></figure>
<p>斜めの縞々を書いてみた。オリジナリティは大事。多分。</p>
<h1>リアル4日目</h1>
<p>date:2018/07/16 00:00-01:30</p>
<p>日をまたいだのでタイトル。さて、やはりポインタを導入するようだが、本書ではint iと宣言しておいて*iと使ってエラーが出てる。当然である。よいこのみんなは変数宣言時にポインタを宣言しようね！で、ポインタの話はすっ飛ばして、色の話。色は当然RGBで設定されていて、16色パレットがあるわけである。その色を自分で設定しようって話らしい。つーことで設定した後がこちら。</p>
<figure><img src="pictures/4-2.png"><figcaption>それでも目に悪い。</figcaption></figure>
<p>さっきよりやや毒々しさが抜けたいつもの色って感じがする(本当に？)そんで、いろいろ頑張った結果が以下のようらしい。</p>
<figure><img src="pictures/4-3.png"><figcaption>著者さん頑張っとるやん</figcaption></figure>
<h2>リアル3日目の感想</h2>
<p>日をまたいじゃったけど。ディスプレイに表示できるようになって、いよいよ本格的にスタートって感じがする。うん。</h2>
<p>date:08:00-11:00</p>
<h2>5日目</h2>
<p>寝て起きて寝るのが杏の生きざま<sup><a class="ref" title="あんずのうたの歌詞から。あんずちゃんかわいい"></a></sup>なので二度寝しま(させない。さて、やっていこう。今日の話はまず構造体だね。これはメモリにあるデータがどんなふうに並べられてるかを記述するやつだね。杏はexeやらgifやらのフォーマットを調べていじってたから知ってるよ。そんで、構造体を使うとスッキリ書けるというわけね。</p>
<p>次は文字の話なんだけど、フォント変えようとしても、ttfなんぞ対応できるわけないし変換もできないので放置。ぐぬぬ…とりあえず理解したので文字表示で遊んでみた。</p>
<figure><img src="pictures/5-1.png"><figcaption>いせにほ<sup><a class="ref" title="Fafs F. Sashimiさん作の言語学なラノベ。転生した主人公が異世界の言語を覚えてって政治的いざこざに巻き込まれる。私が悠里に入ったきっかけ。"></a></sup>、おすすめです。</figcaption></figure>
<p>露骨な宣伝乙、と自分を突っ込みつつ次々。変数表示くんだよ！知ってる～！<sup><a class="ref" title="東京都選挙管理委員会が作ったカオスな動画から。18歳から選挙権！"></a></sup>はい次。マウスカーソル、おお！オリジナリティが出せそう。</p>
<figure><img src="pictures/5-2.png"><figcaption>デフォルトよりはまし。</figcaption></figure>
<p>シャリヤちゃん<sup><a class="ref" title="いせにほのヒロイン。藤ちょこさんマジ神絵っす"></a></sup>描いたんだけど小さくて見えないorz…※杏は色の関係で不可。</p>
<p>この最後はちょっと小難しい話。理解。プログラム用のメモリを分割するセグメンテーションと、CPUの割り込み処理ね。セグメントの管理をGDTに並べて、GDTの先頭アドレスをGDTRに保存、割り込み管理はIDTに並べて、IDTの先頭アドレスをIDTRに保存。簡単。てか、2003fのCPUに割り込み実装しないとなぁ…さて、レポートもあるし、ここでちょっときゅうけーい！<sup><a class="ref" title="けものフレンズのサーバルちゃんがアニメ1話で発したセリフ。"></a></sup></p>
<p>date:13:00-16:00</p>
<h2>6日目</h2>
<p>飯とレポートを終わらせて来た。まずファイル分割をするようだ。これに関しては知ってるので読んだけどスキップ。さて、セグメントと割り込みの話の続きね。GDTに書き込まれる情報を理解した。しっかし、後方互換性をどうにかしようとするとめんどくさい仕様が増えるねぇ。</p>
<p>次、PICの話。CPUじゃ1個しか割り込みの面倒を見切れないので、8個の信号を見てCPUに1個の命令を送ってくれる存在。大抵2個つながってて、計15個の割り込みが可能。ほむ。</p>
<p>次。割り込みハンドラ。割り込み発生→レジスタをスタックに退避→ハンドラ実行→レジスタを戻す→割り込み終了ね。ここで6日目の内容は終わりか―。ひとまず実行しよう。</p>
<figure><img src="pictures/6-1.png"><figcaption>シャリヤスティ<sup><a class="ref" title="異世界語であるリパライン語では、呼格に-stiを付ける。"></a></sup>「断固として動きません」</figcaption></figure>
<p>本にもある通りキーボードは反応するけどマウスは反応がないね。文字が出てくれません。さて、わりかし今回は説明回っぽい感じがした。</p>
<p>date:20:15-21:45</p>
<h2>7日目</h2>
<p>今日は進捗が出まくってるね。まずキーコードを取得…うっ頭が。まぁ、どうせ日本語キーボードのみ想定してることでしょう。16進数表示してるけれども、どうやら離したときは押すキーコード+0x80が返ってくるのね。成程楽しいね。そんで、ハンドラではデータをためるだけにしてメイン関数で文字表示するようにする、と。成程。</p>
<p>さて、マウス。マウスって、今ではキーボードと並んで重要な入力装置だけどさ、登場が1960年後半、仕様が固まったのが1975年ごろ。遅いわな。ほんで、キーボード制御回路にあるマウス制御回路を有効化のちマウス有効化をするわけだな。するとマウスからの割り込みが有効になるのね。</p>
<figure><img src="pictures/7-1.png"><figcaption>キーボードの数字の横にマウスの数字が！</figcaption></figure>
<p>わーい！いよいよ次でシャリヤちゃんが反応してくれるに違いない！</p>
<h2>8日目</h2>
<p>date:22:15-23:15</p>
<p>デレステは楽しいね。ガチャに爆死さえしなければ。で、マウスからの信号を解読しようの巻。マウスからは3バイト来るのでそれを解読して、ボタンとxとyの情報からマウスを動かそうという。完成品がこちらになります。<sup><a class="ref" title="3分クッキングとか。時間短縮は分かるけど、未完成のまま放置された鍋とか電子レンジの処遇はいかに？"></a></sup></p>
<figure><img src="pictures/8-1.png"><figcaption>シャリヤちゃんが反応した！シャリヤスティ(感じちゃうﾋﾞｸﾝﾋﾞｸﾝ)(違うんだよなぁ)</figcaption></figure>
<p>8日目の最後は、asmhead.nas、つまりアセンブリでの初期化コードの<b>†完全理解†</b>。終わり。今日はここまでにしよう。</p>
<h2>今日の感想</h2>
<p>割り込みがメインだったね。これで操作とかもできるようになるし、I/Oの基礎がそろったね。非常にワクワクしてくる。それはさておき、今日は海の日で進捗出たなぁ。平日にも1日分以上は進めたい。2週間で終わらせれたら完璧。<sup><a class="ref" title="大阪大学附属図書館は、2週間で返却、延長可なのだが、めんどいので延長せずに返せたらいいな、と。それに、OUCCの部誌の期限が月末なんだよね。"></a></sup></p>
<h1>リアル5日目</h1>
<p>date:2018/07/17 09:00-13:00</p>
<h2>9日目</h2>
<p>講義を聴きながらの。今回はメモリ管理の話。メモリが使えるかどうかは、繋がっていれば適当な値を入れて出せばちゃんとした値が返ってくる。が、繋がっていないとランダムな値になる。それを利用しているが、CPUについているキャッシュメモリが邪魔してるので切って実行。そのままだとCコンパイラの最適化を食らうのでアセンブリで書くのか。理解。そんで、ある単位ごとにメモリチェックをして、プログラムがある容量を欲するとそれだけ確保してやるわけだが、これってCではmallocってやつだっけな。先週にプログラミングのレポートがあったんだけど、任意の長さの配列を作るのに使ってたな。あれ、9日目割とあっさり？</p>
<h2>10日目</h2>
<p>まずメモリ管理の話。これを要は何バイト単位かでやるって話。欲しいメモリが1234kBで単位が100kBなら1300kB貸すって話ね。はい終わり。</p>
<p>そんで本題。重ね合わせ処理。これはRPGツクールとかウディタ<sup><a class="ref" title="Wolf RPG エディタ。どちらもRPGを作ることができるエディタね。"></a></sup>を使ったことがある人とかPhotoshopかGIMPやらで画像編集したことがある人はレイヤーを思い出せば分かる話っぽいね。多くの枚数のレイヤーを用意して、そんで重ねてVRAMに書き込む。そうするとウィンドウとかマウスとか上手くいってくれるようね。そんで、再描画の関数を最適化するとこう。</p>
<figure><img src="pictures/10-1.png"><figcaption>シャリヤスティと重なってる！(意味深)</figcaption></figure>
<p>わーい！サクサクとマウスが描画を邪魔せずに動いてる！レイヤーの概念を思いついた人に圧倒的感謝…！<sup><a class="ref" title="元ネタはカイジ。本編は見てないから元ネタがどこかわからんけど、中間管理職トネザワは立ち読みした。"></a></sup></p>
<h2>11日目</h2>
<p>まずはマウスを画面右と画面下に隠せるようにしようって話。そこで、今までマウスの座標を制限していたコードをいじるとこうなる。</p>
<figure><img src="pictures/11-1.png"><figcaption>わーっ！わーっ！大変なことに！</figcaption></figure>
<p>vramは横方向に走査するように一つの配列で管理されてるわけだから、そりゃそうなるわなってことなんだけれども。そんでシートを更新する関数を修正してやればちゃんとなるわけだね。</p>
<figure><img src="pictures/11-2.png"><figcaption>Q. Harmie xalija mol fal?<sup><a class="ref" title="シャリヤはどこ？という意味のリパライン語。"></a></sup></figcaption></figure>
<p>無事に隠れてくれて、ソースを書きやすくして次。いよいよウィンドウを出すんだな。さて、ちょっとここでドイツ語の講義を聴いてくる。</p>
<p>date:14:30-15:30</p>
<p>いっひ　しゅぷれっひぇ　かいん　どいちゅ。だす　いすと　しゅヴぃーりひ。<sup><a class="ref" title="ドイツ語は難しいでござる。"></a></sup>さて続き。ウィンドウを作るぞー！と言っても、レイヤーを作ってそこに四角やらバツやらを描くだけなんだけども。描いたものがこちら。</p>
<figure><img src="pictures/11-3.png"><figcaption>OSの自己突っ込み</figcaption></figure>
<p>元ソースだとウィンドウが1つで寂しいので、2つに増やした。これで良し。そんでもって、ウィンドウの更新に関して云々すると上にレイヤーがあってもちらちらしないカウンターができるじゃ。</p>
<figure><img src="pictures/11-4.png"><figcaption>カウントアップ。</figcaption></figure>
<h2>今日の感想</h2>
<p>どんどんOSじみてきたね。マウス動かせるとかウィンドウ表示できるとか。これからどうなるか楽しみ。ちゃんと内部構造も復習しなきゃね。</p>




<footer id="footer"><hr>この画像に載っているプログラムは著者さんのと自分のが混ざったものですが、それに関する著作権を著者さんが放棄してくださっているので載せることができます。本当にありがとうございます。<hr><h1>脚注</h1></footer>
<div id="menu">読み込み中…</div>
<div id="menuButton" onclick="openClose()">≡</div>
<script src="./menu.js" async></script>
</body>
</html>

<!--
<figure><img src="pictures/.png"><figcaption></figcaption></figure>

<sup><a class="ref" title=""></a></sup>
-->